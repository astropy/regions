# STC-S I/O Module for astropy-regions

This module provides support for reading and writing regions in the **STC-S (Space-Time Coordinate String)** format, which is an IVOA (International Virtual Observatory Alliance) standard for describing spatial and temporal regions and coordinates.

## Overview

The STC-S format provides a string representation for astronomical regions that is:
- Standardized by the IVOA
- Human-readable and compact
- Suitable for describing both sky and pixel coordinates
- Compatible with various coordinate systems and reference frames

## Features

- **Reading**: Parse STC-S strings and files into `regions.Region` objects
- **Writing**: Serialize `regions.Region` objects to STC-S format
- **Round-trip**: Full round-trip conversion preserving region properties
- **Multiple Shapes**: Support for circles, ellipses, boxes/rectangles, polygons, and points
- **Coordinate Systems**: Support for ICRS, FK5, FK4, Galactic, Ecliptic, and Image coordinates
- **Reference Positions**: Support for various reference positions (Barycenter, Geocenter, Topocenter, etc.)

## Supported Shapes

| STC-S Shape | astropy-regions Class | Description |
|-------------|----------------------|-------------|
| `Circle` | `CircleSkyRegion` / `CirclePixelRegion` | Circular region |
| `Ellipse` | `EllipseSkyRegion` / `EllipsePixelRegion` | Elliptical region |
| `Box` | `RectangleSkyRegion` / `RectanglePixelRegion` | Rectangular region |
| `Polygon` | `PolygonSkyRegion` / `PolygonPixelRegion` | Polygonal region |
| `Position` | `PointSkyRegion` / `PointPixelRegion` | Point region |

## Usage Examples

### Reading STC-S Files

**Important:** STC-S files cannot be reliably auto-detected and require explicit format specification.

```python
from regions import Regions

# Read from file - MUST specify format='stcs'
regions = Regions.read('regions.stcs', format='stcs')

# Parse STC-S string directly
stcs_string = """
# Example STC-S regions
Circle ICRS BARYCENTER 180.0 10.0 0.5
Ellipse ICRS BARYCENTER 150.0 -20.0 1.0 0.5 45.0
Position FK5 GEOCENTER 85.0 -15.0
"""
regions = Regions.parse(stcs_string, format='stcs')
```

### Writing STC-S Files

```python
import astropy.units as u
from astropy.coordinates import SkyCoord
from regions import Regions
from regions.shapes import CircleSkyRegion, PointSkyRegion

# Create regions
center = SkyCoord(180.0, 10.0, unit='degree', frame='icrs')
circle = CircleSkyRegion(center=center, radius=0.5 * u.degree)

center2 = SkyCoord(85.0, -15.0, unit='degree', frame='fk5')
point = PointSkyRegion(center=center2)

regions = Regions([circle, point])

# Write to file
regions.write('output.stcs', format='stcs', overwrite=True)

# Serialize to string
stcs_string = regions.serialize(format='stcs')
print(stcs_string)
```

### Working with Pixel Coordinates

```python
from regions.core import PixCoord
from regions.shapes import CirclePixelRegion

# Create pixel region
center = PixCoord(100.5, 200.3)
pixel_circle = CirclePixelRegion(center=center, radius=15.0)

# Serialize
stcs_string = pixel_circle.serialize(format='stcs')
# Output: "Circle IMAGE UNKNOWN 100.5 200.3 15"
```

## STC-S Format Specification

### Basic Syntax

```
<Shape> <Frame> <RefPos> <Coordinates> [<Parameters>]
```

### Examples

```stcs
# Circle: center_lon center_lat radius
Circle ICRS BARYCENTER 180.0 10.0 0.5

# Ellipse: center_lon center_lat semi_major semi_minor angle
Ellipse ICRS BARYCENTER 150.0 -20.0 1.0 0.5 45.0

# Box: center_lon center_lat width height angle
Box ICRS BARYCENTER 120.0 30.0 2.0 1.0 0.0

# Polygon: lon1 lat1 lon2 lat2 lon3 lat3 ...
Polygon ICRS BARYCENTER 45.0 45.0 50.0 45.0 50.0 50.0 45.0 50.0

# Position: lon lat
Position FK5 GEOCENTER 85.0 -15.0

# Pixel coordinates
Circle IMAGE UNKNOWN 100.5 200.3 15.0
```

### Coordinate Frames

- **ICRS**: International Celestial Reference System
- **FK5**: Fifth Fundamental Catalogue (J2000.0)
- **FK4**: Fourth Fundamental Catalogue (B1950.0)
- **GALACTIC**: Galactic coordinate system
- **ECLIPTIC**: Ecliptic coordinate system
- **IMAGE**: Pixel/image coordinates

### Reference Positions

- **BARYCENTER**: Solar system barycenter
- **GEOCENTER**: Earth center
- **TOPOCENTER**: Earth surface/topocentric
- **HELIOCENTER**: Sun center
- **LSR**: Local Standard of Rest
- **UNKNOWN**: Unspecified reference

## File Format

STC-S files typically have extensions:
- `.stcs`
- `.stc`
- `.stcs.txt`
- `.stc.txt`

Files can contain:
- Comments starting with `#`
- Multiple regions, one per line
- Blank lines (ignored)

Example file:
```stcs
# STC-S region file
# Generated by astropy-regions

# Central source
Circle ICRS BARYCENTER 180.0 10.0 0.5

# Extended emission
Ellipse ICRS BARYCENTER 150.0 -20.0 1.0 0.5 45.0

# Point sources
Position FK5 GEOCENTER 85.0 -15.0
Position FK5 GEOCENTER 90.0 -10.0
```

## Implementation Details

The STC-S module consists of:

- **`core.py`**: Core parsing functions, mappings, and utilities
- **`connect.py`**: File format identification and registry
- **`read.py`**: STC-S reading and parsing functionality
- **`write.py`**: STC-S writing and serialization functionality
- **`tests/`**: Comprehensive test suite

### Key Functions

- `validate_stcs_string()`: Validate STC-S format
- `parse_coordinate_frame()`: Extract coordinate frame and reference position
- `parse_numbers()`: Parse numeric parameters
- `_parse_stcs()`: Main parsing function
- `_serialize_stcs()`: Main serialization function

## References

- [IVOA STC-S Standard](https://www.ivoa.net/documents/Notes/STC-S/20091030/NOTE-STC-S-1.33-20091030.html)
- [CDS STC-S Rust Implementation](https://github.com/cds-astro/cds-stc-rust/)
- [astropy-regions Issue #21](https://github.com/astropy/regions/issues/21)

## Testing

Run the test suite:
```bash
# Run all STC-S tests
pytest regions/io/stcs/tests/

# Run specific test file
pytest regions/io/stcs/tests/test_stcs.py

# Run with verbose output
pytest regions/io/stcs/tests/ -v
```

Test data files are located in `regions/io/stcs/tests/data/`.

## Contributing

## Known Limitations

### Auto-detection Limitations

- **STC-S files cannot be auto-detected** from content alone, as they lack unique file signatures and use keywords that also appear in DS9, CRTF, and other region formats
- You must always specify `format='stcs'` explicitly when reading STC-S files
- Auto-detection only works based on file extensions (`.stcs`, `.stc`, `.stcs.txt`, `.stc.txt`)

### Feature Limitations

- Some STC-S features, like time coordinates, are not yet supported
- Union, intersection, and other compound operations are not implemented
- Advanced STC-S syntax elements are not parsed, including:
  - Time coordinates and temporal intervals (e.g., `Time TT TOPOCENTER 2000-01-01T12:00:00 2000-01-02T12:00:00`)
  - Spectral coordinates (e.g., `Spectral TOPOCENTER 1420.4 MHz`)
  - Redshift specifications (e.g., `RedshiftInterval BARYCENTER VELOCITY OPTICAL 200.0 2300.0`)
  - Unit specifications (e.g., `unit deg arcsec`)
  - Complex compound operations (e.g., `Union`, `Intersection`, `Difference`, `Not`)
  - Error bounds and uncertainties (e.g., `Error 0.1 0.1`)
  - Resolution and pixel size specifications
- Error handling could be more detailed for malformed input

## Future Enhancements

- Support for temporal coordinates and regions
- Compound region operations (Union, Intersection, etc.)
- More comprehensive error messages
- Integration with STC XML format
